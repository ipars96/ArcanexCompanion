<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Page</title>
<!-- Removed Google Fonts link and used local fonts -->
<style>
/* Font Setup */
@font-face {
    font-family: 'Orbitron';
    src: url('../fonts/orbitron-bold-webfont.ttf') format('truetype');
    font-weight: bold;
}

@font-face {
    font-family: 'Orbitron Medium';
    src: url('../fonts/orbitron-medium-webfont.ttf') format('truetype');
    font-weight: medium;
}

@font-face {
    font-family: 'Noto Sans Condensed';
    src: url('../fonts/NotoSans_Condensed-Regular.ttf') format('truetype');
    font-weight: normal;
}

/* Color Palette */
:root {
    --primary-bg-color: #11181A;
    --secondary-bg-color: #071013;
    --accent-color: #70129e;
    --light-gray: #AAAAAA;
    --main-text-color: #dfe0e2;
    --dark-text-color: #071013;
    --white-color: #FFFFFF;
}

/* Styles for the centered popups */
.centered-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: center;
    z-index: 1000;
    border: 2px solid var(--main-text-color);
    width: 300px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

/* Equip Popup Button Group */
.equip-popup .button-group {
    display: flex;
    justify-content: center; /* Center buttons horizontally */
    gap: 10px; /* Space between buttons */
    flex-wrap: wrap; /* Allow buttons to wrap if needed */
    margin-top: 20px; /* Space from other elements */
}

/* Equip Popup Container */
.equip-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: center;
    z-index: 1000;
    border: 2px solid var(--main-text-color);
    width: auto; /* Auto width to fit content */
    max-width: 90vw; /* Responsive max-width */
    box-sizing: border-box;
}

/* Ensure buttons fit within the popup */
.equip-popup .button {
    min-width: 100px; /* Set a minimum width for buttons */
    padding: 10px 20px; /* Padding for buttons */
    box-sizing: border-box; /* Include padding and border in the width */
}

/* Additional styles for the dice roll result popup */
#dice-roll-result-popup {
    width: 300px;
}

#dice-icon {
    width: 50px;
    margin-bottom: 20px;
}

/* Roll result number */
#roll-result {
    font-size: 3em;
    margin: 10px 0;
    font-family: 'Orbitron', sans-serif;
}

/* Header styles for roll outcomes (Critical Failure, Not Effective, etc.) */
.roll-header {
    font-family: 'Orbitron', sans-serif;
}

/* Description text */
#roll-message p {
    font-family: 'Noto Sans Condensed', sans-serif;
    font-size: 1em;
    margin-top: 10px;
}

/* Spinning animation for the dice */
@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* Apply spin animation */
.spin {
    animation: spin 1s ease-out;
}

/* Add this CSS to define the attack roll popup container */
.attack-roll-popup {
    display: none; /* Hide by default */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    border-radius: 3px;
    border: 2px solid var(--main-text-color);
    box-sizing: border-box;
    overflow: hidden; /* Hide overflow if content is larger */
    width: 600px; /* Initial fixed width */
    height: 400px; /* Initial fixed height */
    max-width: 90vw; /* Maximum width to keep it responsive */
    max-height: 90vh; /* Maximum height to keep it within the viewport */
    z-index: 1000;
    padding: 20px;
}

/* Ensure the close button is always visible */
.attack-roll-popup button {
    position: absolute;
    top: 10px;
    right: 10px;
}

/* General Body Style */
body {
    font-family: 'Noto Sans Condensed', sans-serif;
    background-color: var(--primary-bg-color);
    color: var(--main-text-color);
    margin: 0;
    padding: 0;
    height: 100%;
}

/* Popup Style */
.popup {
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: left;
    border: 2px solid var(--main-text-color);
    box-sizing: border-box;
    width: 100%;
    height: 100%;
}

/* Centered Popup */
.centered-popup {
    display: none; /* Default to hidden */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: center;
    z-index: 1000;
    border: 2px solid var(--main-text-color);
}

/* Inventory Container */
.inventory-container {
    width: 100%;
    height: 100%;
    padding: 10px 20px;
    background-color: var(--secondary-bg-color);
    overflow-y: auto;
    box-sizing: border-box;
}

/* Equipment Section */
.equipment-section {
    margin-bottom: 15px;
    max-height: 33%;
    overflow: hidden;
}

.equipment-title {
    font-family: 'Orbitron', sans-serif; /* Use Orbitron font */
    font-size: 1.2em;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--main-text-color);
}

.equipment-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.equipment-slot {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: var(--light-gray);
    padding: 5px;
    border-radius: 5px;
}

.equipment-slot label {
    font-family: 'Orbitron', sans-serif; /* Use Orbitron */
    font-size: 0.9em;
    margin-bottom: 2px;
    color: var(--dark-text-color);
    font-weight: bold;
    line-height: 1;
}

.equipment-slot input {
    width: 80%;
    padding: 3px;
    border: 1px solid var(--light-gray);
    border-radius: 3px;
    background-color: var(--white-color);
    text-align: center;
    font-size: 0.9em;
    color: var(--dark-text-color);
    transition: box-shadow 0.3s ease-in-out;
}

.equipment-slot input:hover,
.equipment-slot input:focus {
    box-shadow: none; /* No hover glow */
    transform: none; /* No size change */
}

/* Equip Icon */
.equip-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    background-image: url('fonts/equip_icon.png');
    background-size: cover;
    vertical-align: middle;
    margin-right: 5px;
}

/* Separator */
.separator {
    width: 100%;
    height: 2px;
    background-color: #555;
    margin: 15px 0;
}

/* Create Item and Currency Row */
.create-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* Currency Container */
.currency-container {
    display: flex;
    align-items: center;
}

#currency-adjust-button {
    width: 50px;
    padding: 5px;
    margin-right: 5px;
    min-width: 0;
}

#currency {
    width: 100px;
    text-align: center;
}

/* Currency Popup */
.currency-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: center;
    z-index: 1000;
    border: 2px solid var(--main-text-color);
}

.currency-popup-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Delete Popup */
.delete-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--secondary-bg-color);
    color: var(--main-text-color);
    padding: 20px;
    border-radius: 3px;
    text-align: center;
    z-index: 1000;
    border: 2px solid var(--main-text-color);
}

.delete-popup-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.delete-popup-content p {
    margin-bottom: 15px;
    font-size: 1.2em;
}

.currency-popup-content label {
    margin-bottom: 10px;
    font-weight: bold;
    color: var(--main-text-color);
}

#currency-amount {
    width: 80%;
    padding: 8px;
    border: 1px solid var(--light-gray);
    border-radius: 5px;
    margin-bottom: 15px;
    font-size: 1em;
    background-color: var(--white-color);
    color: var(--dark-text-color);
    transition: box-shadow 0.3s ease-in-out;
}

#currency-amount:hover,
#currency-amount:focus {
    box-shadow: 0 0 8px 4px var(--accent-color);
}

.currency-toggle {
    display: flex;
    justify-content: space-around;
    width: 80%;
    margin-bottom: 15px;
}

.currency-toggle input[type="radio"] {
    display: none;
}

.currency-toggle label {
    padding: 8px 12px;
    background-color: var(--light-gray);
    color: var(--dark-text-color);
    border-radius: 5px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    transition: box-shadow 0.3s ease-in-out;
}

.currency-toggle label:hover {
    box-shadow: 0 0 8px 4px var(--accent-color);
}

.currency-toggle input[type="radio"]:checked + label {
    background-color: var(--accent-color);
    color: var(--main-text-color);
}

#currency-submit {
    padding: 10px 20px;
}

/* Button Group */
.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

/* Clickable elements */
.clickable {
    cursor: pointer;
    transition: box-shadow 0.3s ease-in-out;
}

.clickable:hover {
    box-shadow: 0 0 8px 4px var(--accent-color);
}

/* Buttons */
.button {
    padding: 10px 20px;
    background-color: var(--main-text-color);
    color: var(--dark-text-color);
    border: none;
    border-radius: 3px;
    cursor: pointer;
    min-width: 100px;
    transition: box-shadow 0.3s ease-in-out;
    font-family: 'Orbitron', sans-serif;
}

.button:hover, .roll-button:hover {
    box-shadow: 0 0 8px 4px var(--accent-color); /* Purple glow */
    transform: scale(1.1); /* Slight size increase */
    transition: transform 0.1s, box-shadow 0.3s; /* Smooth transition */
}

.button.selected {
    background-color: var(--accent-color);
    color: var(--main-text-color);
}

/* Inputs and Selects */
.input-field,
.select-field {
    padding: 10px;
    border-radius: 3px;
    border: 1px solid var(--light-gray);
    width: 100%;
    font-family: 'Noto Sans Condensed', sans-serif;
    background-color: var(--white-color);
    color: var(--dark-text-color);
    transition: box-shadow 0.3s ease-in-out;
}

.input-field:hover,
.input-field:focus,
.select-field:hover,
.select-field:focus {
    box-shadow: 0 0 8px 4px var(--accent-color);
}

/* Labels */
.label {
    font-weight: bold;
    color: var(--dark-text-color);
}

/* Item Management Section */
.item-management {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    height: calc(100% - 200px); /* Adjust this value if needed */
}

/* Item List Column */
.item-list-column {
    flex: 1;
    overflow-y: auto;
    background-color: var(--light-gray);
    padding: 20px; /* Increase padding to give more space around items */
    border-radius: 3px;
    color: var(--dark-text-color);
}

/* Item List Column */
.item-list-column {
    flex: 1;
    overflow-y: auto;
    background-color: var(--light-gray);
    padding: 25px; /* Increase padding to give more space around items */
    border-radius: 3px;
    color: var(--dark-text-color);
}

/* Hover and selected effect for item containers */
.item-container {
    display: flex;
    align-items: center;
    padding: 8px; /* Increase padding inside each item */
    margin-bottom: 15px; /* Increase margin to create more space between items */
    background-color: var(--white-color);
    border-radius: 3px;
    cursor: pointer;
    transition: box-shadow 0.3s ease-in-out, transform 0.15s ease;
    position: relative;
}

/* Scale effect for hover and selected states */
.item-container:hover,
.item-container.selected {
    transform: scale(1.02); /* Slightly reduce scale to avoid excessive overlap */
    z-index: 1; /* Ensure the item is on top of others */
}

.item-container.selected {
    box-shadow: 0 0 8px 4px var(--accent-color);
}

.item-container input[type="number"] {
    width: 60px;
    margin-right: 10px;
}

.item-container .item-name {
    flex: 1;
    user-select: none;
}

.item-container .delete-button {
    background-color: transparent;
    border: none;
    color: red;
    font-size: 1.2em;
    cursor: pointer;
    margin-left: 10px;
}

.item-container .delete-button:hover {
    color: darkred;
}

/* Item Preview Column */
.item-preview-column {
    flex: 1;
    background-color: var(--light-gray);
    padding: 10px;
    border-radius: 3px;
    color: var(--dark-text-color);
    display: flex;
    flex-direction: column;
    position: relative;
}

.item-preview-column.empty::before {
    content: 'Select an item to view its details';
    color: var(--dark-text-color);
    font-style: italic;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.item-preview {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}

/* Headers in Item Preview Column */
.item-preview label {
    font-family: 'Orbitron', sans-serif; /* Use Orbitron */
    font-weight: bold;
    color: var(--dark-text-color);
}

.item-preview .input-field {
    width: 100%;
}

.item-preview .dropdown-fields {
    display: flex;
    gap: 10px;
}

.item-preview .description-field {
    flex: 1;
    height: 200px; /* Increased height */
    resize: vertical;
}

.item-preview .value-field {
    width: 100px;
}

/* Value Header in Item Preview */
.item-preview .value-field ~ label {
    font-family: 'Orbitron', sans-serif; /* Apply Orbitron font */
    font-weight: bold; /* Use bold weight */
    color: var(--dark-text-color); /* Ensure correct text color */
}

.item-preview .add-attack-button {
    align-self: flex-start;
}

/* Tooltip for input fields */
.input-field[title]:hover::after,
.select-field[title]:hover::after {
    content: attr(title);
    position: absolute;
    background-color: #555;
    color: var(--white-color);
    padding: 5px;
    border-radius: 5px;
    top: -30px;
    left: 0;
    white-space: nowrap;
    z-index: 1;
}

/* Category Header */
.category-header {
    font-family: 'Orbitron', sans-serif; /* Use the Orbitron font */
    font-weight: bold; /* Ensure it's bold */
    font-size: 1.2em;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 2px solid var(--main-text-color);
    color: #071013; /* Change to the new color */
    margin-bottom: 5px; /* Add spacing between the header and items */
}

/* Inventory and Currency Title */
.inventory-title, .currency-title {
    font-family: 'Orbitron', sans-serif; /* Use the Orbitron font */
    font-weight: bold; /* Ensure it's bold */
    color: #DFE0E2; /* Change to the desired color */
    font-size: 1.2em; /* Adjust size if needed */
}

/* Hover and selected effect for item containers */
.item-container {
    position: relative; /* Required for z-index to work */
    transition: transform 0.2s ease, z-index 0.2s; /* Include transition for z-index change */
}

.item-container:hover,
.item-container.selected {
    transform: scale(1.05); /* Scale the item slightly */
    z-index: 1; /* Bring the item to the front */
}

/* Adjust input fields width within attack containers */
.attack-container input[type="text"],
.attack-container input[type="number"],
.attack-container textarea {
    width: 95%; /* Adjust this value as needed */
}

</style>
</head>
<body>
<div class="popup">
    <div class="inventory-container">
        <!-- Equipment Section -->
        <div class="equipment-section">
            <div class="equipment-title">Equipment</div>
            <div class="equipment-grid">
                <!-- Equipment slots here (unchanged) -->
                <div class="equipment-slot">
                    <label for="main-hand" class="label">Main Hand</label>
                    <input type="text" id="main-hand" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="offhand" class="label">Offhand</label>
                    <input type="text" id="offhand" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="armor" class="label">Armor</label>
                    <input type="text" id="armor" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="mana-shield" class="label">Mana Shield</label>
                    <input type="text" id="mana-shield" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="head" class="label">Head</label>
                    <input type="text" id="head" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="back" class="label">Back</label>
                    <input type="text" id="back" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="hands" class="label">Hands</label>
                    <input type="text" id="hands" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="feet" class="label">Feet</label>
                    <input type="text" id="feet" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="finger-1" class="label">Finger 1</label>
                    <input type="text" id="finger-1" class="input-field clickable" readonly>
                </div>
                <div class="equipment-slot">
                    <label for="finger-2" class="label">Finger 2</label>
                    <input type="text" id="finger-2" class="input-field clickable" readonly>
                </div>
            </div>
        </div>
        
        <!-- Separator -->
        <div class="separator"></div>
        
        <!-- Inventory Header and Create Item Button Row -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <!-- Inventory Header -->
                <div class="inventory-title" style="margin-bottom: 15px;">Inventory</div> <!-- Added margin for spacing -->
                <!-- Create Item Button -->
                <button id="create-item" class="button clickable">Create Item</button>
            </div>
            
            <!-- Currency Section (aligned to the right) -->
            <div style="text-align: right;">
                <!-- Currency Header -->
                <div class="currency-title" style="text-align: right; margin-bottom: 15px;">Currency</div> <!-- Right-aligned header and spacing -->
                <!-- Currency Container -->
                <div class="currency-container" style="display: inline-block;">
                    <button id="currency-adjust-button" class="button clickable">+ / -</button>
                    <input type="text" id="currency" class="input-field" placeholder="Currency" readonly>
                </div>
            </div>
        </div>
    
        <!-- Currency Adjustment Popup -->
        <div class="currency-popup" id="currency-popup">
            <div class="currency-popup-content">
                <!-- Currency popup content here (unchanged) -->
                <label for="currency-amount" class="label">Amount:</label>
                <input type="number" id="currency-amount" class="input-field" min="0" value="0">
                <div class="currency-toggle">
                    <input type="radio" id="add" name="currency-action" value="add" checked>
                    <label for="add" class="clickable">Add</label>
                    <input type="radio" id="subtract" name="currency-action" value="subtract">
                    <label for="subtract" class="clickable">Subtract</label>
                </div>
                <div class="button-group">
                    <button id="currency-submit" class="button clickable">Submit</button>
                    <button id="currency-cancel" class="button clickable">Cancel</button>
                </div>
            </div>
        </div>
    
        <!-- Delete Confirmation Popup -->
        <div class="delete-popup" id="delete-popup">
            <div class="delete-popup-content">
                <p>Delete this item?</p>
                <div class="button-group">
                    <button id="delete-confirm" class="button clickable">Confirm</button>
                    <button id="delete-cancel" class="button clickable">Cancel</button>
                </div>
            </div>
        </div>
    
        <!-- Item Management Section -->
        <div class="item-management">
            <!-- Item List Column -->
            <div class="item-list-column" id="item-list-column">
                <!-- Items will be appended here dynamically -->
            </div>
            <!-- Item Preview Column -->
            <div class="item-preview-column empty" id="item-preview-column">
                <!-- Item details will be displayed here when an item is selected -->
            </div>
        </div>
    </div>                
</div>

<!-- Attack Roll Popup -->
<div id="attack-roll-popup" class="centered-popup">
    <h2 id="attack-popup-title">Attack with "AttackName"?</h2>
    <p id="attack-popup-description">
        This attack will cost <span id="attack-ap-cost">0</span> AP & <span id="attack-mp-cost">0</span> MP
    </p>
    <div class="button-group">
        <button id="roll-attack-button" class="button clickable">Roll Attack</button>
        <button id="cancel-attack-button" class="button clickable">Cancel</button>
    </div>
</div>

<!-- Dice Roll Result Popup -->
<div id="dice-roll-result-popup" class="centered-popup">
    <img src="../icons/d20_light_icon.png" alt="D20" id="dice-icon">
    <h2 id="roll-result">0</h2>
    <div id="roll-message">
        <!-- Dynamic result message here -->
    </div>
    <div class="button-group">
        <button id="close-result-button" class="button clickable">Close</button>
    </div>
</div>


<!-- JavaScript -->
<script>

// Add this at the top of your script
const rarityColors = {
    common: '#2e549c',
    uncommon: '#407d39',
    rare: '#86428e',
    'very-rare': '#b73e3e',
    legendary: '#e2a600'
};

// Initialize currency total
let currencyTotal = 0;
const currencyDisplay = document.getElementById('currency');
currencyDisplay.value = currencyTotal;

// Handle 'Create Item' button click
document.getElementById('create-item').addEventListener('click', function() {
    // Create a new item object with blank type and rarity
    const newItem = {
        quantity: 1,
        name: 'New Item',
        type: '', // Set to blank
        rarity: '', // Set to blank
        description: '',
        value: 0,
        equipped: false, // All items start as unequipped
        equipmentSlot: null // Track which slot the item is equipped to
    };
    items.push(newItem);
    renderItemList();
});

// Handle 'Currency Adjust' button click
const currencyAdjustButton = document.getElementById('currency-adjust-button');
const currencyPopup = document.getElementById('currency-popup');
const currencyAmountInput = document.getElementById('currency-amount');
const currencySubmitButton = document.getElementById('currency-submit');
const currencyCancelButton = document.getElementById('currency-cancel');
const currencyActionRadios = document.getElementsByName('currency-action');

currencyAdjustButton.addEventListener('click', function() {
    // Show the currency adjustment popup
    currencyPopup.style.display = 'block';
});

// Handle 'Submit' button click in the currency popup
currencySubmitButton.addEventListener('click', function() {
    const amount = parseFloat(currencyAmountInput.value) || 0;
    let action = 'add';
    for (const radio of currencyActionRadios) {
        if (radio.checked) {
            action = radio.value;
            break;
        }
    }
    if (action === 'add') {
        currencyTotal += amount;
    } else {
        currencyTotal -= amount;
    }
    // Ensure currency total doesn't go below zero
    currencyTotal = Math.max(0, currencyTotal);
    // Update the display
    currencyDisplay.value = currencyTotal;
    // Reset the form
    currencyAmountInput.value = 0;
    document.getElementById('add').checked = true;
    // Hide the popup
    currencyPopup.style.display = 'none';
});

// Handle 'Cancel' button click in the currency popup
currencyCancelButton.addEventListener('click', function() {
    // Hide the popup
    currencyPopup.style.display = 'none';
    // Reset the form
    currencyAmountInput.value = 0;
    document.getElementById('add').checked = true;
});

// Optional: Close the popup when clicking outside of it
window.addEventListener('click', function(event) {
    if (event.target === currencyPopup) {
        currencyPopup.style.display = 'none';
        // Reset the form
        currencyAmountInput.value = 0;
        document.getElementById('add').checked = true;
    }
});

// Initialize an array to store items
let items = [];
let selectedItemIndex = null;
let deleteIndex = null; // Added this line

function renderItemList() {
    const itemListColumn = document.getElementById('item-list-column');
    itemListColumn.innerHTML = ''; // Clear existing items

    // Define categories and their display order
    const categories = ['', 'Consumables', 'Crafting', 'Equipment', 'Loot', 'Quest Items', 'Weapons'];
    
    // Group items by their type
    const itemsByCategory = {};
    categories.forEach(category => {
        itemsByCategory[category] = []; // Initialize each category
    });

    // Sort items into categories
    items.forEach(item => {
        if (categories.includes(item.type)) {
            itemsByCategory[item.type].push(item);
        } else {
            // Handle items with no valid type (appear at the top as blank category)
            if (!itemsByCategory['']) {
                itemsByCategory[''] = [];
            }
            itemsByCategory[''].push(item);
        }
    });

    // Iterate over each category and render the category header and its items
    categories.forEach(category => {
        const categoryItems = itemsByCategory[category];

        if (categoryItems.length > 0) {
            if (category !== '') {
                // Create category header (skip the blank category header)
                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('category-header');
                categoryHeader.textContent = category;
                itemListColumn.appendChild(categoryHeader);
            }

            // Sort items alphabetically by name within the category
            categoryItems.sort((a, b) => a.name.localeCompare(b.name));

            // Render each item in this category
            categoryItems.forEach((item) => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('item-container', 'clickable');
                itemContainer.dataset.index = items.indexOf(item); // Use original index for selection

                // Add selected class if item is selected
                if (selectedItemIndex === items.indexOf(item)) {
                    itemContainer.classList.add('selected');
                }

                // Apply top glow effect based on item rarity
                if (item.rarity && rarityColors[item.rarity]) {
                    itemContainer.style.boxShadow = `0 -4px 8px -3px ${rarityColors[item.rarity]}`;
                } else {
                    itemContainer.style.boxShadow = 'none'; // Remove glow if no rarity
                }

                // Quantity input
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item.quantity;
                quantityInput.title = 'Quantity';
                quantityInput.classList.add('input-field');
                quantityInput.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
                quantityInput.addEventListener('input', function() {
                    item.quantity = parseInt(quantityInput.value) || 1;
                });

                // Item name display (non-editable)
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                nameSpan.title = 'Item Name';
                nameSpan.classList.add('item-name');

                // Add a thicker line under the item name based on rarity
                const rarityLine = document.createElement('div');
                rarityLine.style.height = '6px'; // Increase the height to make the line thicker
                rarityLine.style.backgroundColor = rarityColors[item.rarity] || 'transparent'; // Set line color based on rarity
                rarityLine.style.position = 'absolute';
                rarityLine.style.bottom = '5px'; // Adjust to position under the name
                rarityLine.style.left = '0';
                rarityLine.style.right = '30px'; // Leave space for the trash bin icon

                // Add equip icon if item is equipped
                if (item.equipped) {
                    const equipIcon = document.createElement('img');
                    equipIcon.src = '../icons/equip_icon.png';
                    equipIcon.alt = 'Equipped';
                    equipIcon.classList.add('equip-icon');
                    itemContainer.appendChild(equipIcon); // Add icon first
                }

                itemContainer.appendChild(quantityInput);
                itemContainer.appendChild(nameSpan); // Ensure nameSpan is appended after equipIcon
                itemContainer.appendChild(rarityLine); // Add rarity line

                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '🗑';
                deleteButton.title = 'Delete Item';
                deleteButton.classList.add('delete-button', 'clickable');
                deleteButton.addEventListener('click', function(event) {
                    event.stopPropagation();
                    // Show delete confirmation popup
                    showDeleteConfirmation(items.indexOf(item));
                });

                itemContainer.appendChild(deleteButton);

                // Add click event to select/deselect item
                itemContainer.addEventListener('click', function() {
                    if (selectedItemIndex === items.indexOf(item)) {
                        // Deselect the item
                        selectedItemIndex = null;
                        displayItemDetails();
                        renderItemList(); // Update the item list to remove selection styling
                    } else {
                        selectedItemIndex = items.indexOf(item);
                        displayItemDetails();
                        renderItemList(); // Update the item list to apply selection styling
                    }
                });

                itemListColumn.appendChild(itemContainer);
            });
        }
    });
}

// Function to display item details in the preview column
function displayItemDetails() {
    const itemPreviewColumn = document.getElementById('item-preview-column');
    itemPreviewColumn.classList.remove('empty');
    itemPreviewColumn.innerHTML = ''; // Clear previous content
    if (selectedItemIndex === null) {
        itemPreviewColumn.classList.add('empty');
        return;
    }
    const item = items[selectedItemIndex];
    const itemPreview = document.createElement('div');
    itemPreview.classList.add('item-preview');

    // Define a consistent width for all input fields and dropdowns
    const fieldWidth = 'calc(100% - 30px)'; // Adjust to leave consistent padding
    const fieldInnerPadding = '10px'; // Adjust inner padding for fields

    // Item Name Wrapper
    const nameWrapper = document.createElement('div');
    nameWrapper.style.margin = '0 15px'; // Add consistent margins
    nameWrapper.style.width = fieldWidth; // Set width to be consistent

    // Header for Item Name
    const nameLabel = document.createElement('label');
    nameLabel.textContent = 'Item Name';
    nameLabel.style.color = '#071013'; // Change the header text color
    nameWrapper.appendChild(nameLabel);

    // Item Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = item.name;
    nameInput.classList.add('input-field');
    nameInput.style.width = '100%'; // Full width within the wrapper
    nameInput.style.padding = fieldInnerPadding; // Add padding inside the input
    nameInput.addEventListener('input', function () {
        item.name = nameInput.value;
        renderItemList(); // Update the name in the item list

        // If the item is equipped, update the equipment slot input field
        if (item.equipmentSlot) {
            const slotInput = document.getElementById(item.equipmentSlot);
            if (slotInput) {
                slotInput.value = item.name;
            }
        }
    });

    nameWrapper.appendChild(nameInput); // Add name input to its wrapper

    // Dropdown fields
    const dropdownFields = document.createElement('div');
    dropdownFields.classList.add('dropdown-fields');
    dropdownFields.style.margin = '0 15px'; // Match margins
    dropdownFields.style.width = fieldWidth; // Set width to be consistent

    // Determine the number of dropdowns
    let dropdownCount = item.type === 'Weapons' ? 3 : 2;

    // Calculate the width of each dropdown based on the number of dropdowns
    let dropdownWidth = `${100 / dropdownCount}%`;

    // Item Type dropdown
    const typeSelectWrapper = document.createElement('div');
    typeSelectWrapper.style.width = dropdownWidth;
    const typeLabel = document.createElement('label');
    typeLabel.textContent = 'Item Type';
    typeLabel.style.color = '#071013'; // Header color
    typeSelectWrapper.appendChild(typeLabel);

    const typeSelect = document.createElement('select');
    typeSelect.classList.add('select-field');
    typeSelect.style.width = '100%';

    // Add an empty option at the beginning
    const emptyTypeOption = document.createElement('option');
    emptyTypeOption.value = '';
    emptyTypeOption.textContent = ''; // Show as blank in the dropdown
    typeSelect.appendChild(emptyTypeOption);

    const itemTypes = ['Consumables', 'Crafting', 'Equipment', 'Loot', 'Quest Items', 'Weapons'];
    itemTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
    });
    typeSelect.value = item.type;
    typeSelect.addEventListener('change', function () {
        item.type = typeSelect.value;
        displayItemDetails(); // Re-render details on type change
        renderItemList(); // Update the item list with the new category
    });

    typeSelectWrapper.appendChild(typeSelect);
    dropdownFields.appendChild(typeSelectWrapper);

    // Rarity dropdown
    const raritySelectWrapper = document.createElement('div');
    raritySelectWrapper.style.width = dropdownWidth;
    const rarityLabel = document.createElement('label');
    rarityLabel.textContent = 'Rarity';
    rarityLabel.style.color = '#071013'; // Header color
    raritySelectWrapper.appendChild(rarityLabel);

    const raritySelect = document.createElement('select');
    raritySelect.classList.add('select-field');
    raritySelect.style.width = '100%';

    // Add an empty option at the beginning
    const emptyRarityOption = document.createElement('option');
    emptyRarityOption.value = '';
    emptyRarityOption.textContent = ''; // Show as blank in the dropdown
    raritySelect.appendChild(emptyRarityOption);

    const rarities = [
        { value: 'common', text: 'Common', color: rarityColors.common },
        { value: 'uncommon', text: 'Uncommon', color: rarityColors.uncommon },
        { value: 'rare', text: 'Rare', color: rarityColors.rare },
        { value: 'very-rare', text: 'Very Rare', color: rarityColors['very-rare'] },
        { value: 'legendary', text: 'Legendary', color: rarityColors.legendary }
    ];
    rarities.forEach(rarity => {
        const option = document.createElement('option');
        option.value = rarity.value;
        option.textContent = rarity.text;
        option.style.color = rarity.color;
        raritySelect.appendChild(option);
    });
    raritySelect.value = item.rarity;
    raritySelect.addEventListener('change', function () {
        item.rarity = raritySelect.value;

        // Apply glow effect based on rarity
        raritySelect.style.boxShadow = `0 0 8px 4px ${rarityColors[item.rarity] || 'transparent'}`;
        
        renderItemList(); // Update the item list to reflect rarity line
    });

    // Apply initial glow effect if the item already has a rarity
    raritySelect.style.boxShadow = `0 0 8px 4px ${rarityColors[item.rarity] || 'transparent'}`;
    raritySelectWrapper.appendChild(raritySelect);
    dropdownFields.appendChild(raritySelectWrapper);

    // Weapon Class dropdown (only for Weapons)
    if (item.type === 'Weapons') {
        const weaponClassSelectWrapper = document.createElement('div');
        weaponClassSelectWrapper.style.width = dropdownWidth;
        const weaponClassLabel = document.createElement('label');
        weaponClassLabel.textContent = 'Weapon Class';
        weaponClassLabel.style.color = '#071013'; // Header color
        weaponClassSelectWrapper.appendChild(weaponClassLabel);

        const weaponClassSelect = document.createElement('select');
        weaponClassSelect.classList.add('select-field');
        weaponClassSelect.style.width = '100%';

        const weaponClasses = ['Light Melee', 'Heavy Melee', 'Light Ranged', 'Heavy Ranged', 'Shield'];
        weaponClasses.forEach(weaponClass => {
            const option = document.createElement('option');
            option.value = weaponClass;
            option.textContent = weaponClass;
            weaponClassSelect.appendChild(option);
        });
        weaponClassSelect.value = item.weaponClass || '';
        weaponClassSelect.addEventListener('change', function () {
            item.weaponClass = weaponClassSelect.value;
        });

        weaponClassSelectWrapper.appendChild(weaponClassSelect);
        dropdownFields.appendChild(weaponClassSelectWrapper);
    }

    // Equipment Type dropdown (only for Equipment)
    if (item.type === 'Equipment') {
        const equipmentTypeSelectWrapper = document.createElement('div');
        equipmentTypeSelectWrapper.style.width = dropdownWidth;
        const equipmentTypeLabel = document.createElement('label');
        equipmentTypeLabel.textContent = 'Equipment Type';
        equipmentTypeLabel.style.color = '#071013'; // Header color
        equipmentTypeSelectWrapper.appendChild(equipmentTypeLabel);

        const equipmentTypeSelect = document.createElement('select');
        equipmentTypeSelect.classList.add('select-field');
        equipmentTypeSelect.style.width = '100%';

        // Add Equipment Type options
        const equipmentTypes = ['Armor', 'Mana Shield', 'Head', 'Back', 'Hands', 'Feet', 'Ring'];
        equipmentTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            equipmentTypeSelect.appendChild(option);
        });
        equipmentTypeSelect.value = item.equipmentType || ''; // Default value
        equipmentTypeSelect.addEventListener('change', function () {
            item.equipmentType = equipmentTypeSelect.value;
        });

        equipmentTypeSelectWrapper.appendChild(equipmentTypeSelect);
        dropdownFields.appendChild(equipmentTypeSelectWrapper);
    }

    // Description Field Wrapper
    const descriptionWrapper = document.createElement('div');
    descriptionWrapper.style.margin = '0 15px'; // Add consistent margins
    descriptionWrapper.style.width = fieldWidth; // Set width to be consistent

    // Header for Description
    const descriptionLabel = document.createElement('label');
    descriptionLabel.textContent = 'Item Description';
    descriptionLabel.style.color = '#071013'; // Header color
    descriptionWrapper.appendChild(descriptionLabel);

    // Description field
    const descriptionInput = document.createElement('textarea');
    descriptionInput.value = item.description;
    descriptionInput.classList.add('input-field', 'description-field');
    descriptionInput.style.width = '100%'; // Full width within the wrapper
    descriptionInput.style.resize = 'none'; // Disable resizing
    descriptionInput.addEventListener('input', function () {
        item.description = descriptionInput.value;
    });

    descriptionWrapper.appendChild(descriptionInput); // Add description input to its wrapper

    // Append the basic elements (name, dropdowns, description)
    itemPreview.appendChild(nameWrapper);
    itemPreview.appendChild(dropdownFields);
    itemPreview.appendChild(descriptionWrapper);

    // Only show buttons and value if item type is not empty
    if (item.type !== '') {
        // Button Container
        const buttonContainer = document.createElement('div');
        buttonContainer.classList.add('button-group');

        // Equip Button (Move this to the bottom-left corner of the preview)
        if (item.type === 'Equipment' || item.type === 'Weapons') {
            const equipButton = document.createElement('button');
            equipButton.textContent = item.equipped ? 'Unequip' : 'Equip';
            equipButton.classList.add('button', 'clickable');
            equipButton.style.position = 'absolute'; // Position the button
            equipButton.style.bottom = '25px'; // Place it at the bottom
            equipButton.style.left = '25px'; // Place it on the left side
            equipButton.addEventListener('click', function () {
                if (item.equipped) {
                    unequipItem(item);
                } else {
                    showEquipPopup(item);
                }
            });
            itemPreview.appendChild(equipButton);
        }

        // Add Attack and Remove Attack Buttons for Weapons only
        if (item.type === 'Weapons') {
            const addAttackButton = document.createElement('button');
            addAttackButton.textContent = 'Add Attack';
            addAttackButton.classList.add('button', 'clickable', 'add-attack-button');
            addAttackButton.addEventListener('click', function () {
                addAttack(item);
            });
            buttonContainer.appendChild(addAttackButton);

            // Remove Attack Button
            const removeAttackButton = document.createElement('button');
            removeAttackButton.textContent = 'Remove Attack';
            removeAttackButton.classList.add('button', 'clickable', 'remove-attack-button');
            removeAttackButton.style.display = item.attacks && item.attacks.length > 0 ? 'inline-block' : 'none'; // Initial display state
            removeAttackButton.addEventListener('click', function () {
                // Directly remove the last attack if it exists
                if (item.attacks && item.attacks.length > 0) {
                    item.attacks.pop();
                    displayItemDetails(); // Re-render to show updated attacks
                }
            });
            buttonContainer.appendChild(removeAttackButton);

            // Container for attacks
            const attacksContainer = document.createElement('div');
            attacksContainer.classList.add('attacks-container');
            itemPreview.appendChild(attacksContainer);

            // Display existing attacks
            item.attacks = item.attacks || [];
            item.attacks.forEach((attack, index) => {
                const attackContainer = document.createElement('div');
                attackContainer.classList.add('attack-container');
                attackContainer.style.border = '1px solid #888'; // Container border
                attackContainer.style.padding = '10px';
                attackContainer.style.marginTop = '10px';
                attackContainer.style.borderRadius = '5px';
                attackContainer.style.backgroundColor = '#232627'; // Background color

                // Attack Name, AP Cost, and MP Cost Container
                const attackDetailsContainer = document.createElement('div');
                attackDetailsContainer.style.display = 'flex';
                attackDetailsContainer.style.alignItems = 'center'; // Center items vertically
                attackDetailsContainer.style.gap = '10px'; // Space between elements

                // Attack Name Wrapper
                const attackNameWrapper = document.createElement('div');
                attackNameWrapper.style.flex = '1.5'; // 2/3 of the space
                attackNameWrapper.style.marginLeft = '10px'; // Adjust this value to move it more to the right
                const attackNameLabel = document.createElement('label');
                attackNameLabel.textContent = 'Attack Name';
                attackNameLabel.style.color = '#dfe0e2'; // Header color
                attackNameWrapper.appendChild(attackNameLabel);

                const attackNameInput = document.createElement('input');
                attackNameInput.type = 'text';
                attackNameInput.value = attack.name || '';
                attackNameInput.classList.add('input-field');
                attackNameInput.style.paddingLeft = '10px'; // Add padding on the left
                attackNameInput.style.width = '90%'; // Full width in the wrapper
                attackNameInput.addEventListener('input', function () {
                    item.attacks[index].name = attackNameInput.value;
                });
                attackNameWrapper.appendChild(attackNameInput);
                attackDetailsContainer.appendChild(attackNameWrapper);

                // AP Cost Wrapper
                const apCostWrapper = document.createElement('div');
                apCostWrapper.style.flex = '0.5'; // 1/6 of the space
                const apCostLabel = document.createElement('label');
                apCostLabel.textContent = 'AP Cost';
                apCostLabel.style.color = '#dfe0e2'; // Header color
                apCostWrapper.appendChild(apCostLabel);

                const apCostInput = document.createElement('input');
                apCostInput.type = 'number';
                apCostInput.value = attack.apCost || 0;
                apCostInput.classList.add('input-field');
                apCostInput.style.paddingRight = '5px'; // Adjust padding as needed
                apCostInput.style.width = '70%'; // Full width in the wrapper
                apCostInput.addEventListener('input', function () {
                    item.attacks[index].apCost = parseInt(apCostInput.value) || 0;
                });
                apCostWrapper.appendChild(apCostInput);
                attackDetailsContainer.appendChild(apCostWrapper);

                // MP Cost Wrapper
                const mpCostWrapper = document.createElement('div');
                mpCostWrapper.style.flex = '0.5'; // 1/6 of the space
                const mpCostLabel = document.createElement('label');
                mpCostLabel.textContent = 'MP Cost';
                mpCostLabel.style.color = '#dfe0e2'; // Header color
                mpCostWrapper.appendChild(mpCostLabel);

                const mpCostInput = document.createElement('input');
                mpCostInput.type = 'number';
                mpCostInput.value = attack.mpCost || 0;
                mpCostInput.classList.add('input-field');
                mpCostInput.style.paddingRight = '5px'; // Adjust padding as needed
                mpCostInput.style.width = '70%'; // Full width in the wrapper
                mpCostInput.addEventListener('input', function () {
                    item.attacks[index].mpCost = parseInt(mpCostInput.value) || 0;
                });
                mpCostWrapper.appendChild(mpCostInput);
                attackDetailsContainer.appendChild(mpCostWrapper);

                // Append attack details to attack container
                attackContainer.appendChild(attackDetailsContainer);

                // Description Header and Input
                const attackDescriptionWrapper = document.createElement('div');
                attackDescriptionWrapper.style.margin = '10px 10px'; // Add margin to ensure proper spacing
                const attackDescriptionLabel = document.createElement('label');
                attackDescriptionLabel.textContent = 'Description';
                attackDescriptionLabel.style.color = '#dfe0e2'; // Header color
                attackDescriptionWrapper.appendChild(attackDescriptionLabel);

                const attackDescriptionInput = document.createElement('textarea');
                attackDescriptionInput.value = attack.description || '';
                attackDescriptionInput.classList.add('input-field');
                attackDescriptionInput.style.width = 'calc(97% - 20px)'; // Adjust width to fit within the container
                attackDescriptionInput.style.marginLeft = '-10'; // Add margin for centering
                attackDescriptionInput.style.resize = 'none'; // Disable resizing
                attackDescriptionInput.addEventListener('input', function () {
                    item.attacks[index].description = attackDescriptionInput.value;
                });
                attackDescriptionWrapper.appendChild(attackDescriptionInput);
                attackContainer.appendChild(attackDescriptionWrapper);

                // Range, Target, and Damage Container
                const rangeTargetDamageContainer = document.createElement('div');
                rangeTargetDamageContainer.style.display = 'flex';
                rangeTargetDamageContainer.style.justifyContent = 'space-between';
                rangeTargetDamageContainer.style.gap = '10px'; // Gap between fields
                rangeTargetDamageContainer.style.margin = '0 10px'; // Add margins to fit within the container

                // Range Header and Input
                const attackRangeWrapper = document.createElement('div');
                attackRangeWrapper.style.flex = '1'; // Allow flexible width
                const attackRangeLabel = document.createElement('label');
                attackRangeLabel.textContent = 'Range';
                attackRangeLabel.style.color = '#dfe0e2'; // Header color
                attackRangeWrapper.appendChild(attackRangeLabel);

                const attackRangeInput = document.createElement('input');
                attackRangeInput.type = 'text';
                attackRangeInput.value = attack.range || '';
                attackRangeInput.classList.add('input-field');
                attackRangeInput.style.width = '80%';
                attackRangeInput.addEventListener('input', function () {
                    item.attacks[index].range = attackRangeInput.value;
                });
                attackRangeWrapper.appendChild(attackRangeInput);
                rangeTargetDamageContainer.appendChild(attackRangeWrapper);

                // Target Header and Input
                const attackTargetWrapper = document.createElement('div');
                attackTargetWrapper.style.flex = '1'; // Allow flexible width
                const attackTargetLabel = document.createElement('label');
                attackTargetLabel.textContent = 'Target';
                attackTargetLabel.style.color = '#dfe0e2'; // Header color
                attackTargetWrapper.appendChild(attackTargetLabel);

                const attackTargetInput = document.createElement('input');
                attackTargetInput.type = 'text';
                attackTargetInput.value = attack.target || '';
                attackTargetInput.classList.add('input-field');
                attackTargetInput.style.width = '80%';
                attackTargetInput.addEventListener('input', function () {
                    item.attacks[index].target = attackTargetInput.value;
                });
                attackTargetWrapper.appendChild(attackTargetInput);
                rangeTargetDamageContainer.appendChild(attackTargetWrapper);

                // Damage Header and Container
                const attackDamageWrapper = document.createElement('div');
                attackDamageWrapper.style.flex = '1'; // Allow flexible width
                const attackDamageLabel = document.createElement('label');
                attackDamageLabel.textContent = 'Damage';
                attackDamageLabel.style.color = '#dfe0e2'; // Header color
                attackDamageWrapper.appendChild(attackDamageLabel);

                // Create a container to hold both fields
                const damageContainer = document.createElement('div');
                damageContainer.style.display = 'flex';
                damageContainer.style.gap = '5px'; // Gap between number input and dropdown
                damageContainer.style.width = '100%'; // Adjust width

                // Numeric input for damage
                const attackDamageInput = document.createElement('input');
                attackDamageInput.type = 'number'; // Set type to number
                attackDamageInput.value = attack.damage || '';
                attackDamageInput.classList.add('input-field');
                attackDamageInput.style.flex = '0.3'; // Adjust to take half the space
                attackDamageInput.addEventListener('input', function () {
                    item.attacks[index].damage = parseInt(attackDamageInput.value) || 0;
                });
                damageContainer.appendChild(attackDamageInput);

                // Dropdown for damage type
                const damageTypeSelect = document.createElement('select');
                damageTypeSelect.classList.add('select-field');
                damageTypeSelect.style.flex = '0.6'; // Adjust to take half the space

                // Damage types (alphabetized)
                const damageTypes = ['Cold', 'Corrosive', 'Electric', 'Energy', 'Fire', 'Poison'];
                damageTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    damageTypeSelect.appendChild(option);
                });

                // Set initial selected value if any
                damageTypeSelect.value = attack.damageType || '';
                damageTypeSelect.addEventListener('change', function () {
                    item.attacks[index].damageType = damageTypeSelect.value;
                });
                damageContainer.appendChild(damageTypeSelect);

                attackDamageWrapper.appendChild(damageContainer);
                rangeTargetDamageContainer.appendChild(attackDamageWrapper);

                attackContainer.appendChild(rangeTargetDamageContainer);

                // D20 Roll Button with Icon
                const rollButton = document.createElement('button');
                rollButton.classList.add('roll-button');
                rollButton.style.backgroundColor = '#70129e';
                rollButton.style.border = 'none';
                rollButton.style.borderRadius = '5px';
                rollButton.style.display = 'block';
                rollButton.style.margin = '20px auto';
                rollButton.style.padding = '5px 10px'; // Adjust padding to make it more rectangular
                rollButton.style.cursor = 'pointer';
                rollButton.style.transition = 'box-shadow 0.3s ease-in-out'; // For hover glow

                const d20Icon = document.createElement('img');
                d20Icon.src = '../icons/d20_light_icon.png';
                d20Icon.alt = 'Roll Attack';
                d20Icon.style.width = '40px'; // Slightly larger icon
                rollButton.appendChild(d20Icon);

                // Add purple glow effect on hover
                rollButton.addEventListener('mouseenter', function () {
                    rollButton.style.boxShadow = '0 0 8px 4px #dfe0e2';
                });
                rollButton.addEventListener('mouseleave', function () {
                    rollButton.style.boxShadow = '0 0 8px 4px #70129e'; // Purple glow
                });
                rollButton.addEventListener('mouseleave', function () {
                    rollButton.style.boxShadow = 'none';
                });

                rollButton.addEventListener('click', function () {
                    openAttackRollPopup(attack);
                });

                attackContainer.appendChild(rollButton);
                attacksContainer.appendChild(attackContainer);
            });
        }

        // Add Modifier Button for Equipment
        if (item.type === 'Equipment') {
            const addModifierButton = document.createElement('button');
            addModifierButton.textContent = 'Add Modifier';
            addModifierButton.classList.add('button', 'clickable', 'add-modifier-button');
            // Add event listener for adding modifiers (functionality to be implemented later)
            addModifierButton.addEventListener('click', function () {
                // Placeholder for adding modifiers
                console.log('Add Modifier button clicked for Equipment');
            });
            buttonContainer.appendChild(addModifierButton);
        }

        // Value Field Container
        const valueContainer = document.createElement('div');
        valueContainer.style.display = 'flex';
        valueContainer.style.flexDirection = 'column';
        valueContainer.style.alignItems = 'flex-end'; // Align to the right
        valueContainer.style.marginRight = '10px'; // Add right margin

        // Value Label
        const valueLabel = document.createElement('label');
        valueLabel.textContent = 'Value';
        valueLabel.style.fontWeight = 'bold';
        valueLabel.style.marginBottom = '5px';
        valueLabel.style.color = 'var(--dark-text-color)';

        // Value Input
        const valueInput = document.createElement('input');
        valueInput.type = 'number';
        valueInput.min = '0';
        valueInput.value = item.value;
        valueInput.classList.add('input-field', 'value-field');
        valueInput.title = 'Value';
        valueInput.style.width = '100px';
        valueInput.addEventListener('input', function () {
            item.value = parseFloat(valueInput.value) || 0;
        });

        valueContainer.appendChild(valueLabel);
        valueContainer.appendChild(valueInput);

        // Append buttons and value container to the preview
        itemPreview.appendChild(buttonContainer);
        itemPreview.appendChild(valueContainer);
    }

    itemPreviewColumn.appendChild(itemPreview);
}

// Function to add an attack to a weapon
function addAttack(item) {
    item.attacks.push({ name: '', description: '', range: '', damage: '', apCost: '', mpCost: '' });
    displayItemDetails(); // Re-render to show new attack
}

// Function to show use confirmation popup
function showUseConfirmation() {
    const usePopup = document.createElement('div');
    usePopup.classList.add('centered-popup', 'use-popup');
    usePopup.innerHTML = `
        <div class="popup-content">
            <p>Use Item?</p>
            <div class="button-group">
                <button id="use-confirm" class="button clickable">Confirm</button>
                <button id="use-cancel" class="button clickable">Cancel</button>
            </div>
        </div>
    `;

    document.body.appendChild(usePopup);

    document.getElementById('use-confirm').addEventListener('click', function() {
        if (items[selectedItemIndex].quantity > 0) {
            items[selectedItemIndex].quantity -= 1;
            if (items[selectedItemIndex].quantity === 0) {
                items.splice(selectedItemIndex, 1);
                selectedItemIndex = null;
            }
        }
        renderItemList();
        displayItemDetails();
        document.body.removeChild(usePopup);
    });

    document.getElementById('use-cancel').addEventListener('click', function() {
        document.body.removeChild(usePopup);
    });
}

// Function to show equip popup
function showEquipPopup(item) {
    const equipPopup = document.createElement('div');
    equipPopup.classList.add('centered-popup', 'equip-popup');
    equipPopup.style.display = 'block'; // Ensure the popup is visible

    // Generate equipment slot buttons in two rows of 5
    const equipmentSlots = ['main-hand', 'offhand', 'armor', 'mana-shield', 'head', 'back', 'hands', 'feet', 'finger-1', 'finger-2'];
    let equipmentButtonsHTML = `
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
            ${equipmentSlots.slice(0, 5).map(slot => `
                <button class="button clickable" data-slot="${slot}" style="margin: 2px;">${slot.replace('-', ' ')}</button>
            `).join('')}
        </div>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
            ${equipmentSlots.slice(5).map(slot => `
                <button class="button clickable" data-slot="${slot}" style="margin: 2px;">${slot.replace('-', ' ')}</button>
            `).join('')}
        </div>
    `;

    equipPopup.innerHTML = `
        <div class="popup-content">
            <p>Equip item to:</p>
            ${equipmentButtonsHTML}
            <div class="button-group">
                <button id="equip-confirm" class="button clickable">Confirm</button>
                <button id="equip-cancel" class="button clickable">Cancel</button>
            </div>
        </div>
    `;

    let selectedSlot = null; // Track the selected slot

    // Add event listeners for equipment slot buttons
    equipPopup.querySelectorAll('.button[data-slot]').forEach(button => {
        button.addEventListener('click', function() {
            equipPopup.querySelectorAll('.button[data-slot]').forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            selectedSlot = this.dataset.slot;
        });
    });

    document.body.appendChild(equipPopup);

    document.getElementById('equip-confirm').addEventListener('click', function() {
        if (selectedSlot) {
            equipItemToSlot(item, selectedSlot);
            document.body.removeChild(equipPopup);
        } else {
            alert('Please select a slot to equip the item.');
        }
    });

    document.getElementById('equip-cancel').addEventListener('click', function() {
        document.body.removeChild(equipPopup);
    });
}

// Function to equip item to a specific slot
function equipItemToSlot(item, slot) {
    const slotInput = document.getElementById(slot);
    if (slotInput) {
        // If another item is already equipped in this slot, unequip it
        const currentlyEquipped = items.find(i => i.equipmentSlot === slot);
        if (currentlyEquipped) {
            currentlyEquipped.equipped = false;
            currentlyEquipped.equipmentSlot = null;
        }

        // Equip the new item
        slotInput.value = item.name; // Set the input field to the item's name
        item.equipped = true;
        item.equipmentSlot = slot; // Store the slot ID in the item

        // Apply glow effect based on rarity
        if (item.rarity && rarityColors[item.rarity]) {
            slotInput.style.boxShadow = `0 0 8px 4px ${rarityColors[item.rarity]}`;
        } else {
            slotInput.style.boxShadow = 'none'; // Remove glow if no rarity
        }

        renderItemList();
        displayItemDetails();
    }
}

// Function to unequip item
function unequipItem(item) {
    if (item.equipmentSlot) {
        const slotInput = document.getElementById(item.equipmentSlot);
        if (slotInput) {
            slotInput.value = ''; // Clear the equipment slot
            slotInput.style.boxShadow = 'none'; // Remove glow
        }
        item.equipped = false;
        item.equipmentSlot = null;

        renderItemList();
        displayItemDetails();
    }
}

// Function to show delete confirmation popup
function showDeleteConfirmation(index) {
    deleteIndex = index; // Set the index of the item to delete
    const deletePopup = document.getElementById('delete-popup');
    deletePopup.style.display = 'block';
}

// Set up event listeners for delete confirmation buttons
const deleteConfirmButton = document.getElementById('delete-confirm');
const deleteCancelButton = document.getElementById('delete-cancel');

deleteConfirmButton.addEventListener('click', function () {
    if (deleteIndex !== null) {
        const itemToDelete = items[deleteIndex];

        // If the item is equipped, remove it from the equipment slot
        if (itemToDelete.equipmentSlot) {
            const slotInput = document.getElementById(itemToDelete.equipmentSlot);
            if (slotInput) {
                slotInput.value = ''; // Clear the equipment slot
                slotInput.style.boxShadow = 'none'; // Remove glow
            }
        }

        // Remove the item from the items array
        items.splice(deleteIndex, 1);

        // Deselect if necessary
        if (selectedItemIndex === deleteIndex) {
            selectedItemIndex = null;
            displayItemDetails();
        } else if (selectedItemIndex > deleteIndex) {
            // Adjust selectedItemIndex
            selectedItemIndex--;
        }

        // Update the item list
        renderItemList();
        
        // Hide the popup
        const deletePopup = document.getElementById('delete-popup');
        deletePopup.style.display = 'none';
        
        // Reset deleteIndex
        deleteIndex = null;
    }
});

deleteCancelButton.addEventListener('click', function () {
    // Hide the popup
    const deletePopup = document.getElementById('delete-popup');
    deletePopup.style.display = 'none';
    
    // Reset deleteIndex
    deleteIndex = null;
});

// Close the delete popup when clicking outside of it
window.addEventListener('click', function(event) {
    const deletePopup = document.getElementById('delete-popup');
    if (event.target === deletePopup) {
        deletePopup.style.display = 'none';
        // Reset deleteIndex
        deleteIndex = null;
    }
});

// Open the Attack Roll Popup
function openAttackRollPopup(attack) {
    // Set the attack name and costs
    document.getElementById('attack-popup-title').textContent = `Attack with "${attack.name}"?`;
    document.getElementById('attack-ap-cost').textContent = attack.apCost;
    document.getElementById('attack-mp-cost').textContent = attack.mpCost;

    // Show the popup
    document.getElementById('attack-roll-popup').style.display = 'block';
}

// Handle the Attack Roll
function handleAttackRoll(attack) {
    // Close the attack roll popup
    document.getElementById('attack-roll-popup').style.display = 'none';

    // Show the dice roll result popup immediately
    document.getElementById('dice-roll-result-popup').style.display = 'block';

    // Get the dice icon element
    const diceIcon = document.getElementById('dice-icon');

    // Add the 'spin' class to start the animation
    diceIcon.classList.add('spin');

    // Simulate the dice roll (1d20)
    const roll = Math.floor(Math.random() * 20) + 1;

    // Display the roll result
    displayRollResult(roll);

    // Remove the 'spin' class after the animation (2 seconds)
    setTimeout(function () {
        diceIcon.classList.remove('spin');
    }, 2000); // Match this duration to the animation duration
}

// Display the Roll Result
function displayRollResult(roll) {
    const rollResultElement = document.getElementById('roll-result');
    const rollMessageElement = document.getElementById('roll-message');

    // Set the roll result
    rollResultElement.textContent = roll;

    // Determine the roll outcome
    if (roll === 1) {
        rollResultElement.style.color = 'red';
        rollMessageElement.innerHTML = `<h3 class="roll-header">Critical Failure</h3><p>The attack misses dealing no damage.</p>`;
    } else if (roll >= 2 && roll <= 10) {
        rollResultElement.style.color = '#dfe0e2';
        rollMessageElement.innerHTML = `<h3 class="roll-header">Not Effective</h3><p>Attack deals half damage.</p>`;
    } else if (roll >= 11 && roll <= 19) {
        rollResultElement.style.color = '#dfe0e2';
        rollMessageElement.innerHTML = `<h3 class="roll-header">Effective</h3><p>Attack deals full damage.</p>`;
    } else if (roll === 20) {
        rollResultElement.style.color = 'green';
        rollMessageElement.innerHTML = `<h3 class="roll-header">Critical Success</h3><p>Attack deals double damage.</p>`;
    }
}

// Close the Popups
function closePopups() {
    document.getElementById('attack-roll-popup').style.display = 'none';
    document.getElementById('dice-roll-result-popup').style.display = 'none';
}

// Add event listeners for buttons
document.getElementById('roll-attack-button').addEventListener('click', function () {
    // Simulate rolling the current attack
    handleAttackRoll(currentAttack);
});
document.getElementById('cancel-attack-button').addEventListener('click', closePopups);
document.getElementById('close-result-button').addEventListener('click', closePopups);

// Example: Replace with actual code to link attack button with an attack object
let currentAttack = { name: "Example Attack", apCost: 2, mpCost: 5 };



// Initialize the item list
renderItemList();
</script>
</body>
</html>
