<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #071013;
            color: #071013;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin-top: 60px; /* Adjusted to accommodate the navbar */
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin-top: 20px;
            display: flex;
            gap: 20px;
            padding: 0 20px;
            flex-grow: 1; /* Ensure the container grows to fill available space */
        }
        .left-column, .right-column {
            background-color: #DFE0E2;
            padding: 20px;
            border-radius: 15px;
            flex: 1;
            position: relative;
        }
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            flex-wrap: nowrap;
            padding-right: 15px;
            padding-left: 10px;
            flex: 1;
            cursor: pointer;
        }
        .inventory-item input, .inventory-item select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
        }
        .inventory-item input[name="itemQuantity"] {
            width: 35px;
            flex-shrink: 0;
        }
        .inventory-item input[name="itemName"] {
            flex: 2;
            min-width: 20%;
            cursor: default;
        }
        .inventory-item select[name="itemType"], .inventory-item select[name="itemSubType"] {
            flex: 1.5;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
            background-color: white;
            color: #071013;
            font-family: inherit;
            max-width: 120px;
            min-width: 100px;
        }
        .inventory-item input[name="itemValue"] {
            width: 60px;
            flex-shrink: 0;
            position: relative;
            padding-right: 20px; /* Space for UGC text */
        }
        .info-button, .delete-button {
            background-color: #AAAAAA;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            width: 35px;
        }
        .info-button {
            background-color: #AAAAAA;
            margin-right: 5px;
        }
        .delete-button {
            background-color: #EB5160;
            margin-left: auto;
        }
        .add-item {
            background-color: #EB5160;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .unlock-button {
            background-color: white;
            color: #071013;
            border: 2px solid #AAAAAA;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        .revert-item {
            background-color: white;
            color: #071013;
            border: 2px solid #AAAAAA;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .popup {
            background-color: #DFE0E2;
            padding: 20px;
            border-radius: 10px;
            width: 450px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 1001;
        }
        .popup .action-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .popup .save-button, .popup .close-button, .popup .equip-button {
            background-color: white;
            color: #071013;
            border: 2px solid #AAAAAA;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            width: 48%;
            margin-bottom: 10px;
        }
        .popup .close-button {
            background-color: #EB5160;
            color: white;
        }
        .popup .unequip-button {
            background-color: #EB5160;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            display: none; /* Initially hidden, shown if item is equipped */
        }
        .delete-confirmation {
            text-align: center;
            z-index: 1002;
        }
        .delete-confirmation button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .confirm-button {
            background-color: #EB5160;
            color: white;
        }
        .cancel-button {
            background-color: #AAAAAA;
            color: white;
        }
        .person-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .person-square {
            width: 40px;
            height: 40px;
            background-color: #071013;
            margin: 5px;
            border-radius: 5px;
            position: relative;
        }
        .gear-box {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .gear-box label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .gear-box input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
            width: calc(100% - 20px);
            position: relative;
        }
        .tooltip {
            position: absolute;
            background-color: #DFE0E2;
            color: #071013;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1001;
        }
        .category-divider {
            border-bottom: 1px solid #AAAAAA;
            margin: 20px 0;
        }

        /* Updated CSS */
        .popup .image-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px; /* Add more space below the image */
        }

        .popup .image-container img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer; /* Indicate the image is clickable */
        }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            justify-content: flex-end; /* Align to the right */
        }

        .form-group label {
            flex: 0 0 80px; /* Set width for labels */
            margin-right: 10px; /* Space between label and input */
            font-weight: bold;
            text-align: left;
        }

        .form-group .aligned-input {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
        }

        #popupItemDescription {
            height: 120px; /* Make the description input larger */
            width: 100%; /* Extend description box to full width */
        }

        .details {
            width: 100%; /* Make the details section full width */
        }

        .popup .form-group,
        .popup label,
        .popup input,
        .popup select {
            width: 100%;
            max-width: 350px; /* Align with the width of the description box */
        }

        .popup .inline-group {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .popup .inline-group label, .popup .inline-group select {
            flex: 1;
            max-width: 50%;
        }

        .popup .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .popup #popupWeaponType,
        .popup #popupConsumableType,
        .popup #popupEquipmentType {
            width: 160px;
        }

        /* New CSS for Equipment Grid */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two equal columns */
            gap: 20px;
            margin-top: 20px;
        }

        .equipment-item {
            background-color: #DFE0E2;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px dashed transparent;
            cursor: pointer;
        }

        .equipment-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .equipment-item input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
            background-color: #f0f0f0;
            color: #555;
            text-align: center;
            cursor: not-allowed;
        }

        .equipment-item.small-box {
            padding: 10px;
        }

        .equipment-grid .equipment-item.small-box label {
            margin-bottom: 6px;
        }

        /* Dragging Styles */
        .dragging {
            opacity: 0.5;
        }

        .dragging .dragging-text {
            display: block;
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            background-color: #f0f0f0;
            color: #071013;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
            font-size: 14px;
            top: -9999px;
            left: -9999px;
        }

        .dragging-over {
            border: 2px dashed #071013;
        }

        /* Currency Styling */
        .currency-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        #currencyField {
            width: 80px;
            padding-right: 25px;
            border-radius: 5px;
            border: 1px solid #AAAAAA;
            text-align: right;
            position: relative;
            font-size: 16px;
        }

        #currencyField::after {
            content: "ugc";
            font-size: 10px;
            color: #555;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            opacity: 0.7;
        }

        /* Ensure the same for itemValue fields */
        .inventory-item input[name="itemValue"]::after {
            content: "ugc";
            font-size: 10px;
            color: #555;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            opacity: 0.7;
        }

        .currency-button {
            background-color: #EB5160;
            color: white;
            padding: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Chatbox container styles */
        #chatbox {
            width: 300px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ccc;
            border: 2px solid #DFE0E2;
            border-radius: 10px;
            background-color: #071013;
            color: #DFE0E2;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="navbar"></div> <!-- Placeholder for the navigation bar -->

    <div class="container">
        <!-- Left Column: Inventory Items -->
        <div class="left-column">
            <div class="inventory-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2>Inventory</h2>
                    <div id="inventoryCounter">0/25</div>
                </div>
                <div class="currency-container">
                    <label for="currencyField">Currency</label>
                    <input type="text" id="currencyField" value="0" oninput="formatCurrency(this)">
                    <button class="currency-button" id="addCurrencyButton">+</button>
                    <button class="currency-button" id="subtractCurrencyButton">-</button>
                </div>
            </div>
            <button class="add-item" id="addItemButton" onclick="addItem()">+ Add Item</button>
            <button id="unlockButton" class="unlock-button" onclick="showUnlockPopup()" style="display: none;">Unlock More Inventory</button>
            <!-- Default section for items without a category -->
            <div id="defaultCategory"></div>
            <!-- Categories -->
            <div class="category-divider"></div>
            <h3>Consumables</h3>
            <div id="consumablesCategory"></div>
            <div class="category-divider"></div>
            <h3>Crafting</h3>
            <div id="craftingCategory"></div>
            <div class="category-divider"></div>
            <h3>Equipment</h3>
            <div id="equipmentCategory"></div>
            <div class="category-divider"></div>
            <h3>Loot</h3>
            <div id="lootCategory"></div>
            <div class="category-divider"></div>
            <h3>Notes</h3>
            <div id="notesCategory"></div>
            <div class="category-divider"></div>
            <h3>Quest Items</h3>
            <div id="questItemsCategory"></div>
            <div class="category-divider"></div>
            <h3>Weapons</h3>
            <div id="weaponsCategory"></div>
            <div class="category-divider"></div>

            <!-- Revert Inventory Button -->
            <button id="revertItemButton" class="revert-item" onclick="showRevertPopup()">Revert Inventory</button>
        </div>

        <!-- Right Column: Equipment and Gear -->
        <div class="right-column">
            <h2>Equipment</h3>
            <div class="equipment-grid">
                <div class="equipment-item" data-slot="main-hand" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="main-hand">Main Hand</label>
                    <input type="text" id="main-hand" name="main-hand" readonly>
                </div>
                <div class="equipment-item" data-slot="off-hand" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="off-hand">Off Hand</label>
                    <input type="text" id="off-hand" name="off-hand" readonly>
                </div>
                <div class="equipment-item" data-slot="armor" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="armor">Armor</label>
                    <input type="text" id="armor" name="armor" readonly>
                </div>
                <div class="equipment-item" data-slot="mana-shield" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="mana-shield">Mana Shield</label>
                    <input type="text" id="mana-shield" name="mana-shield" readonly>
                </div>
                <div class="equipment-item" data-slot="head" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="head">Head</label>
                    <input type="text" id="head" name="head" readonly>
                </div>
                <div class="equipment-item" data-slot="back" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="back">Back</label>
                    <input type="text" id="back" name="back" readonly>
                </div>
                <div class="equipment-item" data-slot="hands" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="hands">Hands</label>
                    <input type="text" id="hands" name="hands" readonly>
                </div>
                <div class="equipment-item" data-slot="feet" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="feet">Feet</label>
                    <input type="text" id="feet" name="feet" readonly>
                </div>
                <div class="equipment-item small-box" data-slot="finger1" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="finger1">Finger 1</label>
                    <input type="text" id="finger1" name="finger1" readonly>
                </div>
                <div class="equipment-item small-box" data-slot="finger2" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <label for="finger2">Finger 2</label>
                    <input type="text" id="finger2" name="finger2" readonly>
                </div>
            </div>
        </div>

        <div id="chatbox"></div> <!-- Placeholder for the chatbox -->
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Unlock Inventory Popup -->
    <div class="popup-overlay" id="unlockPopup">
        <div class="popup">
            <p id="unlockMessage">Inventory Full. Upgrade inventory capacity by acquiring the Pack Mule skill.</p>
            <div class="action-buttons">
                <button class="close-button" onclick="closePopup('unlockPopup')">Close</button>
                <button class="save-button" onclick="handleUnlockInventory()">I have acquired the skill</button>
            </div>
        </div>
    </div>

    <!-- Revert Inventory Popup -->
    <div class="popup-overlay" id="revertPopup">
        <div class="popup">
            <p id="revertMessage">Revert inventory capacity to previous tier?</p>
            <div class="action-buttons">
                <button class="close-button" onclick="closePopup('revertPopup')">Close</button>
                <button class="revert-button" onclick="revertInventory()">Revert</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="popup-overlay" id="deleteConfirmation">
        <div class="popup delete-confirmation">
            <p id="deleteConfirmationText">Are you sure you want to delete this item?</p>
            <button class="confirm-button" onclick="confirmDeleteItem()">Delete</button>
            <button class="cancel-button" onclick="closePopup('deleteConfirmation')">Cancel</button>
        </div>
    </div>

    <!-- Equip Confirmation Popup -->
    <div class="popup-overlay" id="equipConfirmationPopup">
        <div class="popup">
            <p id="equipMessage">Equip [Item Name] to [Equipment Slot]? Make sure you’re equipping to the appropriate slot.</p>
            <div class="action-buttons">
                <button class="equip-button" onclick="confirmEquip()">Equip</button>
                <button class="close-button" onclick="cancelEquip()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Unequip Confirmation Popup -->
    <div class="popup-overlay" id="unequipConfirmationPopup" style="z-index: 1002;"> <!-- Ensure higher z-index -->
        <div class="popup">
            <p id="unequipMessage">Unequip [Item Name] from [Equipment Slot]?</p>
            <div class="action-buttons">
                <button class="equip-button" onclick="confirmUnequip()">Unequip</button>
                <button class="close-button" onclick="cancelUnequip()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Info Popup -->
    <div class="popup-overlay" id="infoPopup" style="z-index: 1001;">
        <div class="popup">
            <div class="popup-header">
                <div class="image-container">
                    <img src="https://via.placeholder.com/150" alt="Item Image" id="itemImage" onclick="triggerImageUpload()">
                    <input type="file" id="uploadImage" style="display: none;" accept="image/*" onchange="handleImageUpload(event)">
                </div>
                <div class="details">
                    <div class="form-group">
                        <label for="popupItemName">Item Name</label>
                        <input type="text" id="popupItemName" class="aligned-input" placeholder="Item Name">
                    </div>
                    <div class="inline-group">
                        <div class="form-group">
                            <label for="popupItemType">Type</label>
                            <select id="popupItemType" class="aligned-input" onchange="toggleSubTypeFields(this)">
                                <option value="">Select Type</option>
                                <option value="Consumable">Consumable</option>
                                <option value="Weapon">Weapon</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Crafting">Crafting</option>
                                <option value="Loot">Loot</option>
                                <option value="Notes">Notes</option>
                                <option value="Quest Items">Quest Items</option>
                            </select>
                        </div>
                        <div class="form-group" id="subTypeGroup" style="display:none;">
                            <label for="popupSubType">Sub Type</label>
                            <select id="popupSubType" class="aligned-input">
                                <!-- Subtypes will be dynamically populated based on selected Type -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="popupItemValue">Value</label>
                        <input type="number" id="popupItemValue" class="aligned-input" placeholder="Value" oninput="formatCurrency(this)">
                    </div>
                    <div class="form-group">
                        <label for="popupItemQuantity">Quantity</label>
                        <input type="number" id="popupItemQuantity" class="aligned-input" placeholder="Quantity">
                    </div>
                </div>
                <button class="unequip-button" onclick="showUnequipConfirmation()">Unequip</button> <!-- Unequip button -->
            </div>
            <label for="popupItemDescription">Description</label>
            <textarea id="popupItemDescription" class="description" placeholder="Description"></textarea>
            <div class="action-buttons">
                <button class="save-button" onclick="saveItem()">Save</button>
                <button class="close-button" onclick="closePopup('infoPopup')">Close</button>
            </div>
        </div>
    </div>

    <script>
        let inventoryLimit = 25; // Starting inventory limit
        let currentInventoryCount = 0;
        let currentItemEditing = null;
        let itemToDelete = null;
        let draggedItem = null; // Item being dragged
        let targetSlot = null; // Target equipment slot
        let equipmentSlots = {}; // Track equipped items by slot
        let items = {}; // Store all items by ID

        // Handle image upload and display
        function triggerImageUpload() {
            document.getElementById('uploadImage').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && currentItemEditing) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const itemId = currentItemEditing.dataset.itemId;
                    items[itemId].image = e.target.result;
                    currentItemEditing.querySelector('img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Tooltip logic for inventory input fields
        const tooltip = document.getElementById('tooltip');
        let tooltipTimeout;

        function showTooltip(event, text) {
            tooltip.textContent = text;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
            tooltip.style.opacity = 1;
        }

        function hideTooltip() {
            tooltip.style.opacity = 0;
        }

        const inventoryInputs = document.querySelectorAll('.inventory-item input, .inventory-item select');

        inventoryInputs.forEach(input => {
            input.addEventListener('mouseover', function(event) {
                const label = this.placeholder || this.name; // Use placeholder text or name as the tooltip text
                tooltipTimeout = setTimeout(() => showTooltip(event, label), 1000); // Show tooltip after 1 second
            });

            input.addEventListener('mousemove', function(event) {
                tooltip.style.left = event.pageX + 'px';
                tooltip.style.top = event.pageY + 'px';
            });

            input.addEventListener('mouseout', function() {
                clearTimeout(tooltipTimeout); // Clear the timeout if mouse leaves before tooltip appears
                hideTooltip();
            });
        });

        function updateInventoryCounter() {
            document.getElementById('inventoryCounter').textContent = `${currentInventoryCount}/${inventoryLimit}`;
            const addItemButton = document.getElementById('addItemButton');
            const unlockButton = document.getElementById('unlockButton');

            if (currentInventoryCount >= inventoryLimit) {
                addItemButton.style.display = 'none';
                unlockButton.style.display = 'block';
            } else {
                addItemButton.style.display = 'block';
                unlockButton.style.display = 'none';
            }
        }

        function addItem() {
            if (currentInventoryCount >= inventoryLimit) {
                showUnlockButton();
                return;
            }

            const newItem = document.createElement('div');
            newItem.classList.add('inventory-item');
            newItem.draggable = true; // Make item draggable
            newItem.ondragstart = handleDragStart; // Handle drag start
            newItem.ondragend = handleDragEnd; // Handle drag end
            const itemId = `item-${Date.now()}`; // Unique ID for the item
            newItem.dataset.itemId = itemId; // Assign unique ID
            items[itemId] = {}; // Initialize item data
            newItem.innerHTML = `
                <input type="number" name="itemQuantity" value="1" placeholder="Quantity">
                <input type="text" name="itemName" placeholder="Item Name">
                <select name="itemType" onchange="moveItemToCategory(this)">
                    <option value="">Select Type</option>
                    <option value="Consumable">Consumable</option>
                    <option value="Weapon">Weapon</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Crafting">Crafting</option>
                    <option value="Loot">Loot</option>
                    <option value="Notes">Notes</option>
                    <option value="Quest Items">Quest Items</option>
                </select>
                <select name="itemSubType" style="display:none; max-width: 120px;">
                    <!-- Options will be added based on the item type -->
                </select>
                <input type="number" name="itemValue" placeholder="Value" oninput="formatCurrency(this)">
                <button class="info-button" onclick="showInfoPopup(this)">Info</button>
                <button class="delete-button" onclick="showDeleteConfirmation(this)">🗑️</button>
            `;

            // Place the new item in the defaultCategory section initially
            const defaultCategory = document.getElementById('defaultCategory');
            defaultCategory.appendChild(newItem);

            currentInventoryCount++;
            updateInventoryCounter();
        }

        function moveItemToCategory(selectElement) {
            const item = selectElement.closest('.inventory-item');
            const itemType = selectElement.value;

            const subTypeSelect = item.querySelector('select[name="itemSubType"]');
            subTypeSelect.style.display = 'inline';

            if (itemType === 'Weapon') {
                populateSubTypeSelect(subTypeSelect, ['Light Melee', 'Heavy Melee', 'Light Ranged', 'Heavy Ranged', 'Shield']);
            } else if (itemType === 'Consumable') {
                populateSubTypeSelect(subTypeSelect, ['Potion', 'Food Item', 'Tool', 'Other']);
            } else if (itemType === 'Equipment') {
                populateSubTypeSelect(subTypeSelect, ['Gear', 'Armor', 'Mana Shield', 'Tool', 'Other']);
            } else {
                subTypeSelect.style.display = 'none';
            }

            const defaultCategory = document.getElementById('defaultCategory');
            const categories = {
                'Consumable': document.getElementById('consumablesCategory'),
                'Weapon': document.getElementById('weaponsCategory'),
                'Equipment': document.getElementById('equipmentCategory'),
                'Crafting': document.getElementById('craftingCategory'),
                'Loot': document.getElementById('lootCategory'),
                'Notes': document.getElementById('notesCategory'),
                'Quest Items': document.getElementById('questItemsCategory'),
                '': defaultCategory
            };

            // Move the item to the appropriate category section
            const targetCategory = categories[itemType] || defaultCategory;
            targetCategory.appendChild(item);

            // Sort items alphabetically within the target category
            sortCategoryItemsAlphabetically(targetCategory);
        }

        function populateSubTypeSelect(selectElement, options) {
            selectElement.innerHTML = ''; // Clear existing options
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        function sortCategoryItemsAlphabetically(categoryElement) {
            const items = Array.from(categoryElement.getElementsByClassName('inventory-item'));
            items.sort((a, b) => {
                const nameA = a.querySelector('input[name="itemName"]').value.toLowerCase();
                const nameB = b.querySelector('input[name="itemName"]').value.toLowerCase();
                return nameA.localeCompare(nameB);
            });

            // Re-append sorted items to the category element
            items.forEach(item => categoryElement.appendChild(item));
        }

        function showDeleteConfirmation(button) {
            itemToDelete = button.closest('.inventory-item');
            const itemName = itemToDelete.querySelector('input[name="itemName"]').value;

            const deleteConfirmationText = document.getElementById('deleteConfirmationText');
            deleteConfirmationText.textContent = `Are you sure you want to delete ${itemName}?`;

            const deleteConfirmation = document.getElementById('deleteConfirmation');
            deleteConfirmation.style.display = 'flex';
        }

        function confirmDeleteItem() {
            if (itemToDelete) {
                autoUnequipItem(itemToDelete.querySelector('input[name="itemName"]').value);
                itemToDelete.remove();
                currentInventoryCount--;
                updateInventoryCounter();
            }
            closePopup('deleteConfirmation'); // Close the popup after deletion
        }

        function showInfoPopup(button) {
            currentItemEditing = button.closest('.inventory-item');

            const itemId = currentItemEditing.dataset.itemId;

            const itemName = currentItemEditing.querySelector('input[name="itemName"]').value;
            const itemType = currentItemEditing.querySelector('select[name="itemType"]').value;
            const subType = currentItemEditing.querySelector('select[name="itemSubType"]').value;
            const itemValue = currentItemEditing.querySelector('input[name="itemValue"]').value;
            const itemQuantity = currentItemEditing.querySelector('input[name="itemQuantity"]').value;

            document.getElementById('popupItemName').value = itemName;
            document.getElementById('popupItemType').value = itemType;
            document.getElementById('popupSubType').value = subType;
            document.getElementById('popupItemValue').value = itemValue;
            document.getElementById('popupItemQuantity').value = itemQuantity;

            // Update the item image if it exists
            const itemImage = document.getElementById('itemImage');
            itemImage.src = items[itemId].image || 'https://via.placeholder.com/150';

            toggleSubTypeFields(document.getElementById('popupItemType'));

            // Check if the item is equipped and show the unequip button if so
            const slot = findEquippedSlot(itemName);
            const unequipButton = document.querySelector('.unequip-button');
            if (slot) {
                unequipButton.style.display = 'block';
            } else {
                unequipButton.style.display = 'none';
            }

            const infoPopup = document.getElementById('infoPopup');
            infoPopup.style.display = 'flex';
        }

        function saveItem() {
            if (currentItemEditing) {
                const itemId = currentItemEditing.dataset.itemId;

                const itemName = document.getElementById('popupItemName').value;
                const itemType = document.getElementById('popupItemType').value;
                const subType = document.getElementById('popupSubType').value;
                const itemValue = document.getElementById('popupItemValue').value;
                const itemQuantity = document.getElementById('popupItemQuantity').value;

                currentItemEditing.querySelector('input[name="itemName"]').value = itemName;
                currentItemEditing.querySelector('select[name="itemType"]').value = itemType;
                currentItemEditing.querySelector('select[name="itemSubType"]').value = subType;
                currentItemEditing.querySelector('input[name="itemValue"]').value = itemValue;
                currentItemEditing.querySelector('input[name="itemQuantity"]').value = itemQuantity;

                // Save the item data
                items[itemId] = {
                    name: itemName,
                    type: itemType,
                    subType: subType,
                    value: itemValue,
                    quantity: itemQuantity,
                    image: items[itemId].image
                };

                closePopup('infoPopup');

                // Move the edited item to the correct category
                moveItemToCategory(currentItemEditing.querySelector('select[name="itemType"]'));
            }
        }

        function toggleSubTypeFields(selectElement) {
            const subTypeGroup = document.getElementById('subTypeGroup');
            const subTypeSelect = document.getElementById('popupSubType');

            if (selectElement.value === 'Weapon') {
                subTypeGroup.style.display = 'flex';
                populateSubTypeSelect(subTypeSelect, ['Light Melee', 'Heavy Melee', 'Light Ranged', 'Heavy Ranged', 'Shield']);
            } else if (selectElement.value === 'Consumable') {
                subTypeGroup.style.display = 'flex';
                populateSubTypeSelect(subTypeSelect, ['Potion', 'Food Item', 'Tool', 'Other']);
            } else if (selectElement.value === 'Equipment') {
                subTypeGroup.style.display = 'flex';
                populateSubTypeSelect(subTypeSelect, ['Gear', 'Armor', 'Mana Shield', 'Tool', 'Other']);
            } else {
                subTypeGroup.style.display = 'none';
            }
        }

        // Drag-and-drop logic
        function handleDragStart(event) {
            draggedItem = event.target;
            event.dataTransfer.setData('text/plain', event.target.querySelector('input[name="itemName"]').value);
            event.target.classList.add('dragging');
            
            const dragText = document.createElement('div');
            dragText.classList.add('dragging-text');
            dragText.textContent = event.dataTransfer.getData('text/plain');
            document.body.appendChild(dragText);

            document.addEventListener('mousemove', moveDragText);
        }

        function moveDragText(event) {
            const dragText = document.querySelector('.dragging-text');
            dragText.style.left = `${event.pageX + 5}px`;
            dragText.style.top = `${event.pageY + 5}px`;
        }

        function handleDragEnd() {
            draggedItem.classList.remove('dragging');
            const dragText = document.querySelector('.dragging-text');
            if (dragText) dragText.remove();
            document.removeEventListener('mousemove', moveDragText);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragging-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragging-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            targetSlot = event.currentTarget;
            targetSlot.classList.remove('dragging-over');
            
            const itemName = event.dataTransfer.getData('text/plain');
            const equipMessage = document.getElementById('equipMessage');
            equipMessage.textContent = `Equip ${itemName} to ${targetSlot.querySelector('label').textContent}? Make sure you’re equipping to the appropriate slot.`;

            document.getElementById('equipConfirmationPopup').style.display = 'flex';
        }

        function confirmEquip() {
            const itemName = draggedItem.querySelector('input[name="itemName"]').value;
            targetSlot.querySelector('input').value = itemName;

            // Track the equipped item
            const slotName = targetSlot.dataset.slot;
            equipmentSlots[slotName] = itemName;

            closePopup('equipConfirmationPopup');
        }

        function cancelEquip() {
            closePopup('equipConfirmationPopup');
        }

        function findEquippedSlot(itemName) {
            return Object.keys(equipmentSlots).find(slot => equipmentSlots[slot] === itemName);
        }

        function showUnequipConfirmation() {
            const itemName = document.getElementById('popupItemName').value;
            const slot = findEquippedSlot(itemName);
            const unequipMessage = document.getElementById('unequipMessage');
            unequipMessage.textContent = `Unequip ${itemName} from ${slot}?`;

            document.getElementById('unequipConfirmationPopup').style.display = 'flex';
        }

        function confirmUnequip() {
            const itemName = document.getElementById('popupItemName').value;
            const slot = findEquippedSlot(itemName);

            if (slot) {
                document.getElementById(slot).value = ''; // Clear the equipment slot
                delete equipmentSlots[slot]; // Remove from tracking
            }

            closePopup('unequipConfirmationPopup');
            closePopup('infoPopup'); // Close the item info popup as well
        }

        function cancelUnequip() {
            closePopup('unequipConfirmationPopup');
        }

        function autoUnequipItem(itemName) {
            const slot = findEquippedSlot(itemName);

            if (slot) {
                document.getElementById(slot).value = ''; // Clear the equipment slot
                delete equipmentSlots[slot]; // Remove from tracking
            }
        }

        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            popup.style.display = 'none';
        }

        // Currency-related functionality
        document.getElementById('addCurrencyButton').addEventListener('click', function() {
            showCurrencyPopup('add');
        });

        document.getElementById('subtractCurrencyButton').addEventListener('click', function() {
            showCurrencyPopup('subtract');
        });

        function showCurrencyPopup(action) {
            const popupOverlay = document.createElement('div');
            popupOverlay.classList.add('popup-overlay');
            popupOverlay.style.display = 'flex';
            popupOverlay.innerHTML = `
                <div class="popup">
                    <p>${action === 'add' ? 'Add UGC?' : 'Subtract UGC?'}</p>
                    <div class="form-group">
                        <label for="currencyInput">${action === 'add' ? 'Add Amount' : 'Subtract Amount'}</label>
                        <input type="number" id="currencyInput" class="aligned-input" placeholder="Amount">
                    </div>
                    <div class="action-buttons">
                        <button class="save-button" onclick="${action}Currency()">Confirm</button>
                        <button class="close-button" onclick="closeCurrencyPopup()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popupOverlay);
        }

        function closeCurrencyPopup() {
            const popupOverlay = document.querySelector('.popup-overlay');
            if (popupOverlay) {
                popupOverlay.remove();
            }
        }

        function addCurrency() {
            const currencyInput = document.getElementById('currencyInput').value;
            const currentCurrency = parseInt(document.getElementById('currencyField').value, 10);
            const newCurrency = currentCurrency + parseInt(currencyInput, 10);
            document.getElementById('currencyField').value = newCurrency;
            closeCurrencyPopup();
        }

        function subtractCurrency() {
            const currencyInput = document.getElementById('currencyInput').value;
            const currentCurrency = parseInt(document.getElementById('currencyField').value, 10);
            const newCurrency = currentCurrency - parseInt(currencyInput, 10);
            document.getElementById('currencyField').value = newCurrency < 0 ? 0 : newCurrency;
            closeCurrencyPopup();
        }

        // Format currency fields and item value fields to include UGC text
        function formatCurrency(input) {
            input.value = input.value.replace(/[^\d]/g, ''); // Only allow numbers
        }

        fetch('nav.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            });

        fetch('chatbox.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('chatbox').innerHTML = data;

                // Re-initialize chatbox-related scripts
                const script = document.createElement('script');
                script.textContent = `
                    function sendMessage() {
                        const messageInput = document.getElementById('chatMessage');
                        const messageText = messageInput.value.trim();

                        if (messageText) {
                            const messageContainer = document.createElement('div');
                            messageContainer.textContent = messageText;
                            document.getElementById('chatboxMessages').appendChild(messageContainer);
                            messageInput.value = '';
                            messageInput.focus();
                        }
                    }
                `;
                document.body.appendChild(script);
            });
    </script>
</body>
</html>
